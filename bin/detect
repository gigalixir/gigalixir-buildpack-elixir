#!/usr/bin/env bash

build_pack_dir=$(cd $(dirname $(dirname $0)); pwd)

set -o errexit    # always exit on error
set -o pipefail   # do not ignore exit codes when piping output
unset GIT_DIR     # Avoid GIT_DIR leak from previous build steps

mkdir -p $1 $2 $3 # Ensure dirs are present

build_dir=$(cd $1 && pwd)

mix_file_path="$build_dir/mix.exs"
distillery_file_path="$build_dir/rel/config.exs"
elixir_releases_file_path="$build_dir/config/releases.exs"
elixir_releases_file_path2="$build_dir/config/runtime.exs"

source ${build_pack_dir}/lib/common.sh

load_config

if [ -f $mix_file_url ]; then
  detect_phoenix
  echo -n "Elixir"
  if $phoenix_detected; then
    echo -n "+Phoenix"
  fi
  if [ -f $elixir_releases_file_path ] || [ -f $elixir_releases_file_path2 ]; then
    echo -n "+Releases"
  elif [ -f $distillery_file_path ]; then
    echo -n "+Distillery"
  else
    echo -n "+Mix"
  fi
  echo ""
  exit 0
else
  exit 1
fi

